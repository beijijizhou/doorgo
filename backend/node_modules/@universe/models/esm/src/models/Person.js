import { isNumber, isNumberOrNull, isStringOrNull, isUuid, } from '@universe/util';
import { LangCodeToName } from '../enums/LanguageCode.js';
import { AddressType, isBallotTypeOrNull, isCountryOrNull, isEducationOrNull, isEthnicityOrNull, isGenderOrNull, isLanguageCodeOrNull, isMilitaryStatusOrNull, isNameSuffixOrNull, isPartyOrNull, isPostNominalOrNull, isPreNominalOrNull, isReligionOrNull, isStateOrNull, } from '../index.js';
import { Person as PersonAPI } from '../types/helpers.js';
import { PhoneType, stampPhone } from './Phone.js';
// Given an IPersonPhone, always return a valid IPhone object, even if it's missing the phone on itself.
function getPhone(personPhone) {
    if (!personPhone) {
        return null;
    }
    return personPhone.phone || stampPhone({ number: personPhone.phoneId });
}
// Given two addresses, return the more "complete" object.
// TODO: Make more intelligent.
export function preferredAddress(addr1, addr2) {
    if (!addr1 || !addr2) {
        return addr1 || addr2;
    }
    if (addr1.lat && addr1.lng && (!addr2.lat || !addr2.lng)) {
        return addr1;
    }
    if (addr2.lat && addr2.lng && (!addr1.lat || !addr1.lng)) {
        return addr2;
    }
    if (addr1.number && !addr2.number) {
        return addr1;
    }
    if (addr2.number && !addr1.number) {
        return addr2;
    }
    if (addr1.zip && !addr2.zip) {
        return addr1;
    }
    if (addr2.zip && !addr1.zip) {
        return addr2;
    }
    if (addr1.unitNum && !addr2.unitNum) {
        return addr1;
    }
    if (addr2.unitNum && !addr1.unitNum) {
        return addr2;
    }
    return addr1;
}
function ensureUniqueEntity(key, entities) {
    const discovered = {};
    for (const entity of entities) {
        if (!entity || typeof entity !== 'object') {
            continue;
        }
        key in entity && (discovered[entity[key]] = entity);
    }
    return Object.values(discovered);
}
export function mergeIPerson(...people) {
    const out = Person.stamp();
    for (const person of people) {
        if (!person) {
            continue;
        }
        out.id = out.id || person.id;
        out.countyId = out.countyId ?? person.countyId;
        out.affidavitNum = out.affidavitNum ?? person.affidavitNum;
        out.precinct = out.precinct ?? person.precinct;
        out.createdAt = out.createdAt ?? person.createdAt;
        out.updatedAt = out.updatedAt ?? person.updatedAt;
        out.deletedAt = out.deletedAt ?? person.deletedAt;
        out.preNominal = out.preNominal ?? person.preNominal;
        out.firstName = out.firstName ?? person.firstName;
        out.middleName = out.middleName ?? person.middleName;
        out.lastName = out.lastName ?? person.lastName;
        out.suffix = out.suffix ?? person.suffix;
        out.postNominal = out.postNominal ?? person.postNominal;
        out.nickname = out.nickname ?? person.nickname;
        out.birthDate = out.birthDate ?? person.birthDate;
        out.birthState = out.birthState ?? person.birthState;
        out.birthCountry = out.birthCountry ?? person.birthCountry;
        out.gender = out.gender ?? person.gender;
        out.party = out.party ?? person.party;
        out.ballot = out.ballot ?? person.ballot;
        out.religion = out.religion ?? person.religion;
        out.education = out.education ?? person.education;
        out.military = out.military ?? person.military;
        out.income = out.income ?? person.income;
        out.primaryLanguageCode = out.primaryLanguageCode ?? person.primaryLanguageCode;
        out.secondaryLanguageCode = out.secondaryLanguageCode ?? person.secondaryLanguageCode;
        out.primaryEthnicityCode = out.primaryEthnicityCode ?? person.primaryEthnicityCode;
        out.secondaryEthnicityCode = out.secondaryEthnicityCode ?? person.secondaryEthnicityCode;
        out.phones = ensureUniqueEntity("phoneId", [
            ...(person.phones || []),
            ...(out.phones || []),
        ]);
        out.experience = ensureUniqueEntity("employer", [
            ...(person.experience || []),
            ...(out.experience || []),
        ]);
        out.addresses = ensureUniqueEntity("addressId", [
            ...(person.addresses || []),
            ...(out.addresses || []),
        ]);
        out.emails = ensureUniqueEntity("email", [
            ...(person.emails || []),
            ...(out.emails || []),
        ]);
    }
    return out;
}
export class Person {
    static stamp = PersonAPI.stamp;
    static hydrate = PersonAPI.hydrate;
    static dehydrate = PersonAPI.dehydrate;
    static flatten = PersonAPI.flatten;
    static merge = mergeIPerson;
    static getAccountId(acctType, person) {
        if (!person.accounts) {
            return null;
        }
        for (const acct of person.accounts) {
            if (acct.accountType === acctType) {
                return acct;
            }
        }
        return null;
    }
    static preferredPhone(person) {
        if (!person) {
            return null;
        }
        if (!person.phones || person.phones.length === 0) {
            return null;
        }
        let cell = null;
        let home = null;
        let work = null;
        let other = null;
        for (const phone of person.phones) {
            if (!phone) {
                continue;
            }
            switch (phone.type) {
                case PhoneType.PERS:
                    cell = getPhone(phone) || null;
                    break;
                case PhoneType.HOME:
                    home = getPhone(phone) || null;
                    break;
                case PhoneType.WORK:
                    work = getPhone(phone) || null;
                    break;
                case PhoneType.OTHER:
                    other = getPhone(phone) || null;
                    break;
            }
        }
        return cell || home || work || other || getPhone(person.phones[0]) || null;
    }
    // TODO: Make better
    static currentRole(person) {
        if (!person) {
            return null;
        }
        if (!person.experience || person.experience.length === 0) {
            return null;
        }
        let currentRole = null;
        for (const role of person.experience) {
            if (!currentRole || !currentRole.startDate || +(role.startDate || 0) > +(currentRole?.startDate || 0)) {
                currentRole = role;
            }
        }
        return currentRole;
    }
    // TODO: Make better
    static preferredEmail(person) {
        if (!person) {
            return null;
        }
        if (!person.emails || person.emails.length === 0) {
            return null;
        }
        for (const email of person.emails) {
            if (email.deliverable) {
                return email;
            }
        }
        return person.emails[0] || null;
    }
    static residentialAddress(person) {
        if (!person) {
            return null;
        }
        if (!person.addresses || person.addresses.length === 0) {
            return null;
        }
        let preferred = null;
        for (const addr of person.addresses) {
            if (addr.type !== AddressType.INV && addr.type !== AddressType.MAIL) {
                preferred = preferredAddress(preferred, addr.address || null);
            }
        }
        return preferred;
    }
    static mailAddress(person) {
        if (!person) {
            return null;
        }
        if (!person.addresses || person.addresses.length === 0) {
            return null;
        }
        let preferred = null;
        for (const addr of person.addresses) {
            if (addr.type === AddressType.MAIL) {
                preferred = preferredAddress(preferred, addr.address || null);
            }
        }
        return preferred || Person.residentialAddress(person);
    }
    static age(person) {
        if (!person || !person.birthDate) {
            return null;
        }
        const birthday = +new Date(person.birthDate);
        return ~~((Date.now() - birthday) / (31557600000)); // Magic way to turn a date in to age.
    }
    static fullName(person) {
        if (!person) {
            return null;
        }
        return [person.firstName, person.lastName].join(' ').trim();
    }
    static primaryLanguage(person) {
        if (!person?.primaryLanguageCode) {
            return null;
        }
        return LangCodeToName[person.primaryLanguageCode];
    }
    static secondaryLanguage(person) {
        if (!person?.secondaryLanguageCode) {
            return null;
        }
        return LangCodeToName[person.secondaryLanguageCode];
    }
    static primaryEthnicity(person) {
        if (!person?.primaryEthnicityCode) {
            return null;
        }
        return person.primaryEthnicityCode;
    }
    static secondaryEthnicity(person) {
        if (!person?.secondaryEthnicityCode) {
            return null;
        }
        return person.secondaryEthnicityCode;
    }
}
const defaultPerson = PersonAPI.stamp();
export const personValidator = {
    id: isUuid,
    countyId: isStringOrNull,
    affidavitNum: isStringOrNull,
    createdAt: isNumber,
    updatedAt: isNumber,
    deletedAt: isNumberOrNull,
    preNominal: isPreNominalOrNull,
    firstName: isStringOrNull,
    middleName: isStringOrNull,
    lastName: isStringOrNull,
    postNominal: isPostNominalOrNull,
    suffix: isNameSuffixOrNull,
    nickname: isStringOrNull,
    votes: (v) => Array.isArray(v),
    accounts: (v) => Array.isArray(v),
    addresses: (v) => Array.isArray(v),
    emails: (v) => Array.isArray(v),
    phones: (v) => Array.isArray(v),
    experience: (v) => Array.isArray(v),
    scores: (v) => Array.isArray(v),
    gender: isGenderOrNull,
    party: isPartyOrNull,
    birthDate: isNumberOrNull,
    birthState: isStateOrNull,
    birthCountry: isCountryOrNull,
    religion: isReligionOrNull,
    education: isEducationOrNull,
    military: isMilitaryStatusOrNull,
    income: isNumberOrNull,
    primaryLanguageCode: isLanguageCodeOrNull,
    secondaryLanguageCode: isLanguageCodeOrNull,
    primaryEthnicityCode: isEthnicityOrNull,
    secondaryEthnicityCode: isEthnicityOrNull,
    ballot: isBallotTypeOrNull,
    precinct: isStringOrNull,
};
export const personProps = new Set(Object.keys(personValidator));
/* eslint-disable-next-line @typescript-eslint/no-explicit-any */
export const isPersonProp = (key) => personProps.has(key);
export function isValidPerson(o, log = false) {
    if (!o || typeof o !== 'object') {
        return false;
    }
    let ret = true;
    const person = o;
    for (const key of PersonAPI.keys()) {
        if (!personValidator[key]?.(person[key])) {
            log && log(`Unsanitary Data for person "${person.id}". Invalid value for ${key}: ${JSON.stringify(person[key], null, 2)}`);
            ret = false;
        }
    }
    return ret;
}
export function ensurePerson(o) {
    for (const key of Object.keys(o)) {
        if (!isPersonProp(key)) {
            delete o[key];
        }
    }
    for (const key of personProps) {
        if (!personValidator[key]?.(o[key])) {
            o[key] = defaultPerson[key];
        }
    }
    return PersonAPI.hydrate(o);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGVyc29uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21vZGVscy9QZXJzb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFFBQVEsRUFDUixjQUFjLEVBQ2QsY0FBYyxFQUNkLE1BQU0sR0FDUCxNQUFNLGdCQUFnQixDQUFDO0FBRXhCLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMxRCxPQUFPLEVBQ0wsV0FBVyxFQWVYLGtCQUFrQixFQUVsQixlQUFlLEVBQ2YsaUJBQWlCLEVBQ2pCLGlCQUFpQixFQUNqQixjQUFjLEVBQ2Qsb0JBQW9CLEVBQ3BCLHNCQUFzQixFQUN0QixrQkFBa0IsRUFDbEIsYUFBYSxFQUNiLG1CQUFtQixFQUNuQixrQkFBa0IsRUFDbEIsZ0JBQWdCLEVBQ2hCLGFBQWEsR0FXZCxNQUFNLGFBQWEsQ0FBQztBQUNyQixPQUFPLEVBQUUsTUFBTSxJQUFJLFNBQVMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTFELE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBTW5ELHdHQUF3RztBQUN4RyxTQUFTLFFBQVEsQ0FBQyxXQUFpQztJQUNqRCxJQUFJLENBQUMsV0FBVyxFQUFFO1FBQUUsT0FBTyxJQUFJLENBQUM7S0FBRTtJQUNsQyxPQUFPLFdBQVcsQ0FBQyxLQUFLLElBQUksVUFBVSxDQUFDLEVBQUUsTUFBTSxFQUFFLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0FBQzFFLENBQUM7QUFFRCwwREFBMEQ7QUFDMUQsK0JBQStCO0FBQy9CLE1BQU0sVUFBVSxnQkFBZ0IsQ0FBQyxLQUFzQixFQUFFLEtBQXNCO0lBQzdFLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxLQUFLLEVBQUU7UUFBRSxPQUFPLEtBQUssSUFBSSxLQUFLLENBQUM7S0FBRTtJQUVoRCxJQUFJLEtBQUssQ0FBQyxHQUFHLElBQUksS0FB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QyxFQUFFLENBQUMsQ0FBQztZQUMzSCxHQUFHLEdBQUcsS0FBSyxDQUFDO1NBQ2I7S0FDRjtJQUNELE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQUVELE1BQU0sVUFBVSxZQUFZLENBQUMsQ0FBOEM7SUFDekUsS0FBSyxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ2hDLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFBRSxPQUFPLENBQUMsQ0FBQyxHQUFvQixDQUFDLENBQUM7U0FBRTtLQUM1RDtJQUNELEtBQUssTUFBTSxHQUFHLElBQUksV0FBVyxFQUFFO1FBQzdCLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtZQUFHLENBQUMsQ0FBQyxHQUFHLENBQWEsR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7U0FBRTtLQUNuRjtJQUNELE9BQU8sU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM5QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgaXNOdW1iZXIsXG4gIGlzTnVtYmVyT3JOdWxsLFxuICBpc1N0cmluZ09yTnVsbCxcbiAgaXNVdWlkLFxufSBmcm9tICdAdW5pdmVyc2UvdXRpbCc7XG5cbmltcG9ydCB7IExhbmdDb2RlVG9OYW1lIH0gZnJvbSAnLi4vZW51bXMvTGFuZ3VhZ2VDb2RlLmpzJztcbmltcG9ydCB7XG4gIEFkZHJlc3NUeXBlLFxuICBCYWxsb3RUeXBlLFxuICBDb3VudHJ5LFxuICBFZHVjYXRpb24sXG4gIEV0aG5pY2l0eSxcbiAgR2VuZGVyLFxuICBJQWNjb3VudCxcbiAgSUFkZHJlc3MsXG4gIElFbWFpbCxcbiAgSUV4cGVyaWVuY2UsXG4gIElQYXJ0aWFsUGVyc29uLFxuICBJUGVyc29uLFxuICBJUGVyc29uQWRkcmVzcyxcbiAgSVBlcnNvblBob25lLFxuICBJUGhvbmUsXG4gIGlzQmFsbG90VHlwZU9yTnVsbCxcbiAgSVNjb3JlLFxuICBpc0NvdW50cnlPck51bGwsXG4gIGlzRWR1Y2F0aW9uT3JOdWxsLFxuICBpc0V0aG5pY2l0eU9yTnVsbCxcbiAgaXNHZW5kZXJPck51bGwsXG4gIGlzTGFuZ3VhZ2VDb2RlT3JOdWxsLFxuICBpc01pbGl0YXJ5U3RhdHVzT3JOdWxsLFxuICBpc05hbWVTdWZmaXhPck51bGwsXG4gIGlzUGFydHlPck51bGwsXG4gIGlzUG9zdE5vbWluYWxPck51bGwsXG4gIGlzUHJlTm9taW5hbE9yTnVsbCxcbiAgaXNSZWxpZ2lvbk9yTnVsbCxcbiAgaXNTdGF0ZU9yTnVsbCxcbiAgSVZvdGUsXG4gIExhbmd1YWdlQ29kZSxcbiAgTWF5YmUsXG4gIE1pbGl0YXJ5U3RhdHVzLFxuICBOYW1lU3VmZml4LFxuICBQYXJ0eSxcbiAgUG9zdE5vbWluYWwsXG4gIFByZU5vbWluYWwsXG4gIFJlbGlnaW9uLFxuICBTdGF0ZSxcbn0gZnJvbSAnLi4vaW5kZXguanMnO1xuaW1wb3J0IHsgUGVyc29uIGFzIFBlcnNvbkFQSSB9IGZyb20gJy4uL3R5cGVzL2hlbHBlcnMuanMnO1xuaW1wb3J0IHsgQWNjb3VudFR5cGUgfSBmcm9tICcuL0FjY291bnQuanMnO1xuaW1wb3J0IHsgUGhvbmVUeXBlLCBzdGFtcFBob25lIH0gZnJvbSAnLi9QaG9uZS5qcyc7XG5cbi8vIFRPRE86IENvZGVnZW4gdmFsaWRhdG9ycy5cbmV4cG9ydCB0eXBlIFZhbGlkYXRvcjxUPiA9IHsgW2tleSBpbiBrZXlvZiBUXTogKHY6IHVua25vd24pID0+IHYgaXMgVFtrZXldIH07XG5leHBvcnQgdHlwZSBMb2dnZXIgPSBmYWxzZSB8ICgobXNnOiBzdHJpbmcpID0+IHZvaWQpO1xuXG4vLyBHaXZlbiBhbiBJUGVyc29uUGhvbmUsIGFsd2F5cyByZXR1cm4gYSB2YWxpZCBJUGhvbmUgb2JqZWN0LCBldmVuIGlmIGl0J3MgbWlzc2luZyB0aGUgcGhvbmUgb24gaXRzZWxmLlxuZnVuY3Rpb24gZ2V0UGhvbmUocGVyc29uUGhvbmU/OiBJUGVyc29uUGhvbmUgfCBudWxsKTogSVBob25lIHwgbnVsbCB7XG4gIGlmICghcGVyc29uUGhvbmUpIHsgcmV0dXJuIG51bGw7IH1cbiAgcmV0dXJuIHBlcnNvblBob25lLnBob25lIHx8IHN0YW1wUGhvbmUoeyBudW1iZXI6IHBlcnNvblBob25lLnBob25lSWQgfSk7XG59XG5cbi8vIEdpdmVuIHR3byBhZGRyZXNzZXMsIHJldHVybiB0aGUgbW9yZSBcImNvbXBsZXRlXCIgb2JqZWN0LlxuLy8gVE9ETzogTWFrZSBtb3JlIGludGVsbGlnZW50LlxuZXhwb3J0IGZ1bmN0aW9uIHByZWZlcnJlZEFkZHJlc3MoYWRkcjE6IElBZGRyZXNzIHwgbnVsbCwgYWRkcjI6IElBZGRyZXNzIHwgbnVsbCk6IElBZGRyZXNzIHwgbnVsbCB7XG4gIGlmICghYWRkcjEgfHwgIWFkZHIyKSB7IHJldHVybiBhZGRyMSB8fCBhZGRyMjsgfVxuXG4gIGlmIChhZGRyMS5sYXQgJiYgYWRkcjEubG5nICYmICghYWRkcjIubGF0IHx8ICFhZGRyMi5sbmcpKSB7IHJldHVybiBhZGRyMTsgfVxuICBpZiAoYWRkcjIubGF0ICYmIGFkZHIyLmxuZyAmJiAoIWFkZHIxLmxhdCB8fCAhYWRkcjEubG5nKSkgeyByZXR1cm4gYWRkcjI7IH1cblxuICBpZiAoYWRkcjEubnVtYmVyICYmICFhZGRyMi5udW1iZXIpIHsgcmV0dXJuIGFkZHIxOyB9XG4gIGlmIChhZGRyMi5udW1iZXIgJiYgIWFkZHIxLm51bWJlcikgeyByZXR1cm4gYWRkcjI7IH1cblxuICBpZiAoYWRkcjEuemlwICYmICFhZGRyMi56aXApIHsgcmV0dXJuIGFkZHIxOyB9XG4gIGlmIChhZGRyMi56aXAgJiYgIWFkZHIxLnppcCkgeyByZXR1cm4gYWRkcjI7IH1cblxuICBpZiAoYWRkcjEudW5pdE51bSAmJiAhYWRkcjIudW5pdE51bSkgeyByZXR1cm4gYWRkcjE7IH1cbiAgaWYgKGFkZHIyLnVuaXROdW0gJiYgIWFkZHIxLnVuaXROdW0pIHsgcmV0dXJuIGFkZHIyOyB9XG5cbiAgcmV0dXJuIGFkZHIxO1xufVxuXG5mdW5jdGlvbiBlbnN1cmVVbmlxdWVFbnRpdHkoa2V5OiBcInBob25lSWRcIiwgZW50aXRpZXM6IElQZXJzb25QaG9uZVtdKTogSVBlcnNvblBob25lW107XG5mdW5jdGlvbiBlbnN1cmVVbmlxdWVFbnRpdHkoa2V5OiBcImFkZHJlc3NJZFwiLCBlbnRpdGllczogSVBlcnNvbkFkZHJlc3NbXSk6IElQZXJzb25BZGRyZXNzW107XG5mdW5jdGlvbiBlbnN1cmVVbmlxdWVFbnRpdHkoa2V5OiBcImVtYWlsXCIsIGVudGl0aWVzOiBJRW1haWxbXSk6IElFbWFpbFtdO1xuZnVuY3Rpb24gZW5zdXJlVW5pcXVlRW50aXR5KGtleTogXCJlbXBsb3llclwiLCBlbnRpdGllczogSUV4cGVyaWVuY2VbXSk6IElFeHBlcmllbmNlW107XG5mdW5jdGlvbiBlbnN1cmVVbmlxdWVFbnRpdHk8XG4gIFQgZXh0ZW5kcyBJUGVyc29uUGhvbmUgfCBJUGVyc29uQWRkcmVzcyB8IElFbWFpbCB8IElFeHBlcmllbmNlXG4+KGtleToga2V5b2YgVCwgZW50aXRpZXM6IFRbXSk6IFRbXSB7XG4gIGNvbnN0IGRpc2NvdmVyZWQ6IFJlY29yZDxzdHJpbmcsIFQ+ID0ge307XG4gIGZvciAoY29uc3QgZW50aXR5IG9mIGVudGl0aWVzKSB7XG4gICAgaWYgKCFlbnRpdHkgfHwgdHlwZW9mIGVudGl0eSAhPT0gJ29iamVjdCcpIHsgY29udGludWU7IH1cbiAgICBrZXkgaW4gZW50aXR5ICYmIChkaXNjb3ZlcmVkW2VudGl0eVtrZXldIGFzIHN0cmluZ10gPSBlbnRpdHkpO1xuICB9XG4gIHJldHVybiBPYmplY3QudmFsdWVzKGRpc2NvdmVyZWQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVyZ2VJUGVyc29uKC4uLnBlb3BsZTogKElQYXJ0aWFsUGVyc29uIHwgbnVsbCB8IHVuZGVmaW5lZClbXSk6IElQZXJzb24ge1xuICBjb25zdCBvdXQgPSBQZXJzb24uc3RhbXAoKTtcbiAgZm9yIChjb25zdCBwZXJzb24gb2YgcGVvcGxlKSB7XG4gICAgaWYgKCFwZXJzb24pIHsgY29udGludWU7IH1cbiAgICBvdXQuaWQgPSBvdXQuaWQgfHwgcGVyc29uLmlkO1xuICAgIG91dC5jb3VudHlJZCA9IG91dC5jb3VudHlJZCA/PyAocGVyc29uLmNvdW50eUlkIGFzIHN0cmluZyk7XG4gICAgb3V0LmFmZmlkYXZpdE51bSA9IG91dC5hZmZpZGF2aXROdW0gPz8gKHBlcnNvbi5hZmZpZGF2aXROdW0gYXMgc3RyaW5nKTtcbiAgICBvdXQucHJlY2luY3QgPSBvdXQucHJlY2luY3QgPz8gKHBlcnNvbi5wcmVjaW5jdCBhcyBzdHJpbmcpO1xuICAgIG91dC5jcmVhdGVkQXQgPSBvdXQuY3JlYXRlZEF0ID8/IHBlcnNvbi5jcmVhdGVkQXQ7XG4gICAgb3V0LnVwZGF0ZWRBdCA9IG91dC51cGRhdGVkQXQgPz8gcGVyc29uLnVwZGF0ZWRBdDtcbiAgICBvdXQuZGVsZXRlZEF0ID0gb3V0LmRlbGV0ZWRBdCA/PyAocGVyc29uLmRlbGV0ZWRBdCBhcyBudW1iZXIpO1xuICAgIG91dC5wcmVOb21pbmFsID0gb3V0LnByZU5vbWluYWwgPz8gKHBlcnNvbi5wcmVOb21pbmFsIGFzIE1heWJlPFByZU5vbWluYWw+KTtcbiAgICBvdXQuZmlyc3ROYW1lID0gb3V0LmZpcnN0TmFtZSA/PyAocGVyc29uLmZpcnN0TmFtZSBhcyBzdHJpbmcpO1xuICAgIG91dC5taWRkbGVOYW1lID0gb3V0Lm1pZGRsZU5hbWUgPz8gKHBlcnNvbi5taWRkbGVOYW1lIGFzIHN0cmluZyk7XG4gICAgb3V0Lmxhc3ROYW1lID0gb3V0Lmxhc3ROYW1lID8/IChwZXJzb24ubGFzdE5hbWUgYXMgc3RyaW5nKTtcbiAgICBvdXQuc3VmZml4ID0gb3V0LnN1ZmZpeCA/PyAocGVyc29uLnN1ZmZpeCBhcyBNYXliZTxOYW1lU3VmZml4Pik7XG4gICAgb3V0LnBvc3ROb21pbmFsID0gb3V0LnBvc3ROb21pbmFsID8/IChwZXJzb24ucG9zdE5vbWluYWwgYXMgTWF5YmU8UG9zdE5vbWluYWw+KTtcbiAgICBvdXQubmlja25hbWUgPSBvdXQubmlja25hbWUgPz8gKHBlcnNvbi5uaWNrbmFtZSBhcyBzdHJpbmcpO1xuICAgIG91dC5iaXJ0aERhdGUgPSBvdXQuYmlydGhEYXRlID8/IChwZXJzb24uYmlydGhEYXRlIGFzIG51bWJlcik7XG4gICAgb3V0LmJpcnRoU3RhdGUgPSBvdXQuYmlydGhTdGF0ZSA/PyAocGVyc29uLmJpcnRoU3RhdGUgYXMgTWF5YmU8U3RhdGU+KTtcbiAgICBvdXQuYmlydGhDb3VudHJ5ID0gb3V0LmJpcnRoQ291bnRyeSA/PyAocGVyc29uLmJpcnRoQ291bnRyeSBhcyBNYXliZTxDb3VudHJ5Pik7XG4gICAgb3V0LmdlbmRlciA9IG91dC5nZW5kZXIgPz8gKHBlcnNvbi5nZW5kZXIgYXMgTWF5YmU8R2VuZGVyPik7XG4gICAgb3V0LnBhcnR5ID0gb3V0LnBhcnR5ID8/IChwZXJzb24ucGFydHkgYXMgTWF5YmU8UGFydHk+KTtcbiAgICBvdXQuYmFsbG90ID0gb3V0LmJhbGxvdCA/PyAocGVyc29uLmJhbGxvdCBhcyBNYXliZTxCYWxsb3RUeXBlPik7XG4gICAgb3V0LnJlbGlnaW9uID0gb3V0LnJlbGlnaW9uID8/IChwZXJzb24ucmVsaWdpb24gYXMgTWF5YmU8UmVsaWdpb24+KTtcbiAgICBvdXQuZWR1Y2F0aW9uID0gb3V0LmVkdWNhdGlvbiA/PyAocGVyc29uLmVkdWNhdGlvbiBhcyBNYXliZTxFZHVjYXRpb24+KTtcbiAgICBvdXQubWlsaXRhcnkgPSBvdXQubWlsaXRhcnkgPz8gKHBlcnNvbi5taWxpdGFyeSBhcyBNYXliZTxNaWxpdGFyeVN0YXR1cz4pO1xuICAgIG91dC5pbmNvbWUgPSBvdXQuaW5jb21lID8/IChwZXJzb24uaW5jb21lIGFzIG51bWJlcik7XG4gICAgb3V0LnByaW1hcnlMYW5ndWFnZUNvZGUgPSBvdXQucHJpbWFyeUxhbmd1YWdlQ29kZSA/PyAocGVyc29uLnByaW1hcnlMYW5ndWFnZUNvZGUgYXMgTWF5YmU8TGFuZ3VhZ2VDb2RlPik7XG4gICAgb3V0LnNlY29uZGFyeUxhbmd1YWdlQ29kZSA9IG91dC5zZWNvbmRhcnlMYW5ndWFnZUNvZGUgPz8gKHBlcnNvbi5zZWNvbmRhcnlMYW5ndWFnZUNvZGUgYXMgTWF5YmU8TGFuZ3VhZ2VDb2RlPik7XG4gICAgb3V0LnByaW1hcnlFdGhuaWNpdHlDb2RlID0gb3V0LnByaW1hcnlFdGhuaWNpdHlDb2RlID8/IChwZXJzb24ucHJpbWFyeUV0aG5pY2l0eUNvZGUgYXMgTWF5YmU8RXRobmljaXR5Pik7XG4gICAgb3V0LnNlY29uZGFyeUV0aG5pY2l0eUNvZGUgPSBvdXQuc2Vjb25kYXJ5RXRobmljaXR5Q29kZSA/PyAocGVyc29uLnNlY29uZGFyeUV0aG5pY2l0eUNvZGUgYXMgTWF5YmU8RXRobmljaXR5Pik7XG4gICAgb3V0LnBob25lcyA9IGVuc3VyZVVuaXF1ZUVudGl0eShcInBob25lSWRcIiwgW1xuICAgICAgLi4uKHBlcnNvbi5waG9uZXMgfHwgW10pLFxuICAgICAgLi4uKG91dC5waG9uZXMgfHwgW10pLFxuICAgIF0gYXMgSVBlcnNvblBob25lW10pO1xuICAgIG91dC5leHBlcmllbmNlID0gZW5zdXJlVW5pcXVlRW50aXR5KFwiZW1wbG95ZXJcIiwgW1xuICAgICAgLi4uKHBlcnNvbi5leHBlcmllbmNlIHx8IFtdKSxcbiAgICAgIC4uLihvdXQuZXhwZXJpZW5jZSB8fCBbXSksXG4gICAgXSBhcyBJRXhwZXJpZW5jZVtdKTtcbiAgICBvdXQuYWRkcmVzc2VzID0gZW5zdXJlVW5pcXVlRW50aXR5KFwiYWRkcmVzc0lkXCIsIFtcbiAgICAgIC4uLihwZXJzb24uYWRkcmVzc2VzIHx8IFtdKSxcbiAgICAgIC4uLihvdXQuYWRkcmVzc2VzIHx8IFtdKSxcbiAgICBdIGFzIElQZXJzb25BZGRyZXNzW10pO1xuICAgIG91dC5lbWFpbHMgPSBlbnN1cmVVbmlxdWVFbnRpdHkoXCJlbWFpbFwiLCBbXG4gICAgICAuLi4ocGVyc29uLmVtYWlscyB8fCBbXSksXG4gICAgICAuLi4ob3V0LmVtYWlscyB8fCBbXSksXG4gICAgXSBhcyBJRW1haWxbXSk7XG4gIH1cbiAgcmV0dXJuIG91dDtcbn1cblxuZXhwb3J0IGNsYXNzIFBlcnNvbiB7XG4gIHN0YXRpYyBzdGFtcCA9IFBlcnNvbkFQSS5zdGFtcDtcbiAgc3RhdGljIGh5ZHJhdGUgPSBQZXJzb25BUEkuaHlkcmF0ZTtcbiAgc3RhdGljIGRlaHlkcmF0ZSA9IFBlcnNvbkFQSS5kZWh5ZHJhdGU7XG4gIHN0YXRpYyBmbGF0dGVuID0gUGVyc29uQVBJLmZsYXR0ZW47XG4gIHN0YXRpYyBtZXJnZSA9IG1lcmdlSVBlcnNvbjtcblxuICBzdGF0aWMgZ2V0QWNjb3VudElkKGFjY3RUeXBlOiBBY2NvdW50VHlwZSwgcGVyc29uOiBJUGVyc29uKTogSUFjY291bnQgfCBudWxsIHtcbiAgICBpZiAoIXBlcnNvbi5hY2NvdW50cykgeyByZXR1cm4gbnVsbDsgfVxuICAgIGZvciAoY29uc3QgYWNjdCBvZiBwZXJzb24uYWNjb3VudHMpIHtcbiAgICAgIGlmIChhY2N0LmFjY291bnRUeXBlID09PSBhY2N0VHlwZSkgeyByZXR1cm4gYWNjdCBhcyBJQWNjb3VudDsgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHN0YXRpYyBwcmVmZXJyZWRQaG9uZShwZXJzb24/OiBQYXJ0aWFsPElQZXJzb24+IHwgbnVsbCk6IElQaG9uZSB8IG51bGwge1xuICAgIGlmICghcGVyc29uKSB7IHJldHVybiBudWxsOyB9XG4gICAgaWYgKCFwZXJzb24ucGhvbmVzIHx8IHBlcnNvbi5waG9uZXMubGVuZ3RoID09PSAwKSB7IHJldHVybiBudWxsOyB9XG5cbiAgICBsZXQgY2VsbDogSVBob25lIHwgbnVsbCA9IG51bGw7XG4gICAgbGV0IGhvbWU6IElQaG9uZSB8IG51bGwgPSBudWxsO1xuICAgIGxldCB3b3JrOiBJUGhvbmUgfCBudWxsID0gbnVsbDtcbiAgICBsZXQgb3RoZXI6IElQaG9uZSB8IG51bGwgPSBudWxsO1xuXG4gICAgZm9yIChjb25zdCBwaG9uZSBvZiBwZXJzb24ucGhvbmVzKSB7XG4gICAgICBpZiAoIXBob25lKSB7IGNvbnRpbnVlOyB9XG4gICAgICBzd2l0Y2ggKHBob25lLnR5cGUpIHtcbiAgICAgICAgY2FzZSBQaG9uZVR5cGUuUEVSUzogY2VsbCA9IGdldFBob25lKHBob25lKSB8fCBudWxsOyBicmVhaztcbiAgICAgICAgY2FzZSBQaG9uZVR5cGUuSE9NRTogaG9tZSA9IGdldFBob25lKHBob25lKSB8fCBudWxsOyBicmVhaztcbiAgICAgICAgY2FzZSBQaG9uZVR5cGUuV09SSzogd29yayA9IGdldFBob25lKHBob25lKSB8fCBudWxsOyBicmVhaztcbiAgICAgICAgY2FzZSBQaG9uZVR5cGUuT1RIRVI6IG90aGVyID0gZ2V0UGhvbmUocGhvbmUpIHx8IG51bGw7IGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gY2VsbCB8fCBob21lIHx8IHdvcmsgfHwgb3RoZXIgfHwgZ2V0UGhvbmUocGVyc29uLnBob25lc1swXSkgfHwgbnVsbDtcbiAgfVxuXG4gIC8vIFRPRE86IE1ha2UgYmV0dGVyXG4gIHN0YXRpYyBjdXJyZW50Um9sZShwZXJzb24/OiBQYXJ0aWFsPElQZXJzb24+IHwgbnVsbCk6IElFeHBlcmllbmNlIHwgbnVsbCB7XG4gICAgaWYgKCFwZXJzb24pIHsgcmV0dXJuIG51bGw7IH1cbiAgICBpZiAoIXBlcnNvbi5leHBlcmllbmNlIHx8IHBlcnNvbi5leHBlcmllbmNlLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gbnVsbDsgfVxuXG4gICAgbGV0IGN1cnJlbnRSb2xlOiBJRXhwZXJpZW5jZSB8IG51bGwgPSBudWxsO1xuICAgIGZvciAoY29uc3Qgcm9sZSBvZiBwZXJzb24uZXhwZXJpZW5jZSkge1xuICAgICAgaWYgKCFjdXJyZW50Um9sZSB8fCAhY3VycmVudFJvbGUuc3RhcnREYXRlIHx8ICsocm9sZS5zdGFydERhdGUgfHwgMCkgPiArKGN1cnJlbnRSb2xlPy5zdGFydERhdGUgfHwgMCkpIHtcbiAgICAgICAgY3VycmVudFJvbGUgPSByb2xlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjdXJyZW50Um9sZTtcbiAgfVxuXG4gIC8vIFRPRE86IE1ha2UgYmV0dGVyXG4gIHN0YXRpYyBwcmVmZXJyZWRFbWFpbChwZXJzb24/OiBQYXJ0aWFsPElQZXJzb24+IHwgbnVsbCk6IElFbWFpbCB8IG51bGwge1xuICAgIGlmICghcGVyc29uKSB7IHJldHVybiBudWxsOyB9XG4gICAgaWYgKCFwZXJzb24uZW1haWxzIHx8IHBlcnNvbi5lbWFpbHMubGVuZ3RoID09PSAwKSB7IHJldHVybiBudWxsOyB9XG5cbiAgICBmb3IgKGNvbnN0IGVtYWlsIG9mIHBlcnNvbi5lbWFpbHMpIHtcbiAgICAgIGlmIChlbWFpbC5kZWxpdmVyYWJsZSkgeyByZXR1cm4gZW1haWw7IH1cbiAgICB9XG5cbiAgICByZXR1cm4gcGVyc29uLmVtYWlsc1swXSB8fCBudWxsO1xuICB9XG5cbiAgc3RhdGljIHJlc2lkZW50aWFsQWRkcmVzcyhwZXJzb24/OiBQYXJ0aWFsPElQZXJzb24+IHwgbnVsbCk6IElBZGRyZXNzIHwgbnVsbCB7XG4gICAgaWYgKCFwZXJzb24pIHsgcmV0dXJuIG51bGw7IH1cbiAgICBpZiAoIXBlcnNvbi5hZGRyZXNzZXMgfHwgcGVyc29uLmFkZHJlc3Nlcy5sZW5ndGggPT09IDApIHsgcmV0dXJuIG51bGw7IH1cbiAgICBsZXQgcHJlZmVycmVkOiBJQWRkcmVzcyB8IG51bGwgPSBudWxsO1xuICAgIGZvciAoY29uc3QgYWRkciBvZiBwZXJzb24uYWRkcmVzc2VzKSB7XG4gICAgICBpZiAoYWRkci50eXBlICE9PSBBZGRyZXNzVHlwZS5JTlYgJiYgYWRkci50eXBlICE9PSBBZGRyZXNzVHlwZS5NQUlMKSB7XG4gICAgICAgIHByZWZlcnJlZCA9IHByZWZlcnJlZEFkZHJlc3MocHJlZmVycmVkLCBhZGRyLmFkZHJlc3MgfHwgbnVsbCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHByZWZlcnJlZDtcbiAgfVxuXG4gIHN0YXRpYyBtYWlsQWRkcmVzcyhwZXJzb24/OiBQYXJ0aWFsPElQZXJzb24+IHwgbnVsbCk6IElBZGRyZXNzIHwgbnVsbCB7XG4gICAgaWYgKCFwZXJzb24pIHsgcmV0dXJuIG51bGw7IH1cbiAgICBpZiAoIXBlcnNvbi5hZGRyZXNzZXMgfHwgcGVyc29uLmFkZHJlc3Nlcy5sZW5ndGggPT09IDApIHsgcmV0dXJuIG51bGw7IH1cblxuICAgIGxldCBwcmVmZXJyZWQ6IElBZGRyZXNzIHwgbnVsbCA9IG51bGw7XG4gICAgZm9yIChjb25zdCBhZGRyIG9mIHBlcnNvbi5hZGRyZXNzZXMpIHtcbiAgICAgIGlmIChhZGRyLnR5cGUgPT09IEFkZHJlc3NUeXBlLk1BSUwpIHtcbiAgICAgICAgcHJlZmVycmVkID0gcHJlZmVycmVkQWRkcmVzcyhwcmVmZXJyZWQsIGFkZHIuYWRkcmVzcyB8fCBudWxsKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcHJlZmVycmVkIHx8IFBlcnNvbi5yZXNpZGVudGlhbEFkZHJlc3MocGVyc29uKTtcbiAgfVxuXG4gIHN0YXRpYyBhZ2UocGVyc29uPzogUGFydGlhbDxJUGVyc29uPiB8IG51bGwpOiBudW1iZXIgfCBudWxsIHtcbiAgICBpZiAoIXBlcnNvbiB8fCAhcGVyc29uLmJpcnRoRGF0ZSkgeyByZXR1cm4gbnVsbDsgfVxuICAgIGNvbnN0IGJpcnRoZGF5ID0gK25ldyBEYXRlKHBlcnNvbi5iaXJ0aERhdGUpO1xuICAgIHJldHVybiB+figoRGF0ZS5ub3coKSAtIGJpcnRoZGF5KSAvICgzMTU1NzYwMDAwMCkpOyAvLyBNYWdpYyB3YXkgdG8gdHVybiBhIGRhdGUgaW4gdG8gYWdlLlxuICB9XG5cbiAgc3RhdGljIGZ1bGxOYW1lKHBlcnNvbj86IFBhcnRpYWw8SVBlcnNvbj4gfCBudWxsKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgaWYgKCFwZXJzb24pIHsgcmV0dXJuIG51bGw7IH1cbiAgICByZXR1cm4gWyBwZXJzb24uZmlyc3ROYW1lLCBwZXJzb24ubGFzdE5hbWUgXS5qb2luKCcgJykudHJpbSgpO1xuICB9XG5cbiAgc3RhdGljIHByaW1hcnlMYW5ndWFnZShwZXJzb24/OiBQYXJ0aWFsPElQZXJzb24+IHwgbnVsbCk6IHN0cmluZyB8IG51bGwge1xuICAgIGlmICghcGVyc29uPy5wcmltYXJ5TGFuZ3VhZ2VDb2RlKSB7IHJldHVybiBudWxsOyB9XG4gICAgcmV0dXJuIExhbmdDb2RlVG9OYW1lW3BlcnNvbi5wcmltYXJ5TGFuZ3VhZ2VDb2RlXTtcbiAgfVxuXG4gIHN0YXRpYyBzZWNvbmRhcnlMYW5ndWFnZShwZXJzb24/OiBQYXJ0aWFsPElQZXJzb24+IHwgbnVsbCk6IHN0cmluZyB8IG51bGwge1xuICAgIGlmICghcGVyc29uPy5zZWNvbmRhcnlMYW5ndWFnZUNvZGUpIHsgcmV0dXJuIG51bGw7IH1cbiAgICByZXR1cm4gTGFuZ0NvZGVUb05hbWVbcGVyc29uLnNlY29uZGFyeUxhbmd1YWdlQ29kZV07XG4gIH1cblxuICBzdGF0aWMgcHJpbWFyeUV0aG5pY2l0eShwZXJzb24/OiBQYXJ0aWFsPElQZXJzb24+IHwgbnVsbCk6IHN0cmluZyB8IG51bGwge1xuICAgIGlmICghcGVyc29uPy5wcmltYXJ5RXRobmljaXR5Q29kZSkgeyByZXR1cm4gbnVsbDsgfVxuICAgIHJldHVybiBwZXJzb24ucHJpbWFyeUV0aG5pY2l0eUNvZGU7XG4gIH1cblxuICBzdGF0aWMgc2Vjb25kYXJ5RXRobmljaXR5KHBlcnNvbj86IFBhcnRpYWw8SVBlcnNvbj4gfCBudWxsKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgaWYgKCFwZXJzb24/LnNlY29uZGFyeUV0aG5pY2l0eUNvZGUpIHsgcmV0dXJuIG51bGw7IH1cbiAgICByZXR1cm4gcGVyc29uLnNlY29uZGFyeUV0aG5pY2l0eUNvZGU7XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgUGVyc29uUHJvcHMgPSBrZXlvZiBJUGVyc29uO1xuXG5jb25zdCBkZWZhdWx0UGVyc29uOiBJUGVyc29uID0gUGVyc29uQVBJLnN0YW1wKCk7XG5leHBvcnQgY29uc3QgcGVyc29uVmFsaWRhdG9yOiBWYWxpZGF0b3I8SVBlcnNvbj4gPSB7XG5cbiAgaWQ6IGlzVXVpZCxcbiAgY291bnR5SWQ6IGlzU3RyaW5nT3JOdWxsLFxuICBhZmZpZGF2aXROdW06IGlzU3RyaW5nT3JOdWxsLFxuXG4gIGNyZWF0ZWRBdDogaXNOdW1iZXIsXG4gIHVwZGF0ZWRBdDogaXNOdW1iZXIsXG4gIGRlbGV0ZWRBdDogaXNOdW1iZXJPck51bGwsXG5cbiAgcHJlTm9taW5hbDogaXNQcmVOb21pbmFsT3JOdWxsLFxuICBmaXJzdE5hbWU6IGlzU3RyaW5nT3JOdWxsLFxuICBtaWRkbGVOYW1lOiBpc1N0cmluZ09yTnVsbCxcbiAgbGFzdE5hbWU6IGlzU3RyaW5nT3JOdWxsLFxuICBwb3N0Tm9taW5hbDogaXNQb3N0Tm9taW5hbE9yTnVsbCxcbiAgc3VmZml4OiBpc05hbWVTdWZmaXhPck51bGwsXG4gIG5pY2tuYW1lOiBpc1N0cmluZ09yTnVsbCxcblxuICB2b3RlczogKHY6IHVua25vd24pOiB2IGlzIElWb3RlW10gPT4gQXJyYXkuaXNBcnJheSh2KSwgLy8gaXNWb3RlT3JOdWxsLFxuICBhY2NvdW50czogKHY6IHVua25vd24pOiB2IGlzIElBY2NvdW50W10gPT4gQXJyYXkuaXNBcnJheSh2KSwgLy8gaXNBY2NvdW50T3JOdWxsLFxuICBhZGRyZXNzZXM6ICh2OiB1bmtub3duKTogdiBpcyBJUGVyc29uQWRkcmVzc1tdID0+IEFycmF5LmlzQXJyYXkodiksIC8vIGlzQWRkcmVzc09yTnVsbCxcbiAgZW1haWxzOiAodjogdW5rbm93bik6IHYgaXMgSUVtYWlsW10gPT4gQXJyYXkuaXNBcnJheSh2KSwgLy8gVE9ETzogSW1wbGVtZW50IHRlbCB2YWxpZGF0aW9uLlxuICBwaG9uZXM6ICh2OiB1bmtub3duKTogdiBpcyBJUGVyc29uUGhvbmVbXSA9PiBBcnJheS5pc0FycmF5KHYpLCAvLyBUT0RPOiBJbXBsZW1lbnQgdGVsIHZhbGlkYXRpb24uXG4gIGV4cGVyaWVuY2U6ICh2OiB1bmtub3duKTogdiBpcyBJRXhwZXJpZW5jZVtdID0+IEFycmF5LmlzQXJyYXkodiksIC8vIFRPRE86IEltcGxlbWVudCBleHBlcmllbmNlIHZhbGlkYXRpb24uXG4gIHNjb3JlczogKHY6IHVua25vd24pOiB2IGlzIElTY29yZVtdID0+IEFycmF5LmlzQXJyYXkodiksIC8vIFRPRE86IEltcGxlbWVudCBzY29yZSB2YWxpZGF0aW9uLlxuXG4gIGdlbmRlcjogaXNHZW5kZXJPck51bGwsXG4gIHBhcnR5OiBpc1BhcnR5T3JOdWxsLFxuICBiaXJ0aERhdGU6IGlzTnVtYmVyT3JOdWxsLFxuICBiaXJ0aFN0YXRlOiBpc1N0YXRlT3JOdWxsLFxuICBiaXJ0aENvdW50cnk6IGlzQ291bnRyeU9yTnVsbCxcbiAgcmVsaWdpb246IGlzUmVsaWdpb25Pck51bGwsXG4gIGVkdWNhdGlvbjogaXNFZHVjYXRpb25Pck51bGwsXG4gIG1pbGl0YXJ5OiBpc01pbGl0YXJ5U3RhdHVzT3JOdWxsLFxuICBpbmNvbWU6IGlzTnVtYmVyT3JOdWxsLFxuXG4gIHByaW1hcnlMYW5ndWFnZUNvZGU6IGlzTGFuZ3VhZ2VDb2RlT3JOdWxsLFxuICBzZWNvbmRhcnlMYW5ndWFnZUNvZGU6IGlzTGFuZ3VhZ2VDb2RlT3JOdWxsLFxuICBwcmltYXJ5RXRobmljaXR5Q29kZTogaXNFdGhuaWNpdHlPck51bGwsXG4gIHNlY29uZGFyeUV0aG5pY2l0eUNvZGU6IGlzRXRobmljaXR5T3JOdWxsLFxuXG4gIGJhbGxvdDogaXNCYWxsb3RUeXBlT3JOdWxsLFxuICBwcmVjaW5jdDogaXNTdHJpbmdPck51bGwsXG59O1xuXG5leHBvcnQgY29uc3QgcGVyc29uUHJvcHM6IFNldDxrZXlvZiBJUGVyc29uPiA9IG5ldyBTZXQoT2JqZWN0LmtleXMocGVyc29uVmFsaWRhdG9yKSkgYXMgU2V0PGtleW9mIElQZXJzb24+O1xuLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnkgKi9cbmV4cG9ydCBjb25zdCBpc1BlcnNvblByb3AgPSAoa2V5OiBzdHJpbmcpOiBrZXkgaXMgUGVyc29uUHJvcHMgPT4gcGVyc29uUHJvcHMuaGFzKChrZXkgYXMgYW55KSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1ZhbGlkUGVyc29uKG86IHVua25vd24sIGxvZzogTG9nZ2VyID0gZmFsc2UpOiBvIGlzIElQZXJzb24ge1xuICBpZiAoIW8gfHwgdHlwZW9mIG8gIT09ICdvYmplY3QnKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbGV0IHJldCA9IHRydWU7XG4gIGNvbnN0IHBlcnNvbjogUGFydGlhbDxJUGVyc29uPiA9IG8gYXMgUGFydGlhbDxJUGVyc29uPjtcbiAgZm9yIChjb25zdCBrZXkgb2YgUGVyc29uQVBJLmtleXMoKSkge1xuICAgIGlmICghcGVyc29uVmFsaWRhdG9yW2tleV0/LihwZXJzb25ba2V5XSkpIHtcbiAgICAgIGxvZyAmJiBsb2coYFVuc2FuaXRhcnkgRGF0YSBmb3IgcGVyc29uIFwiJHtwZXJzb24uaWR9XCIuIEludmFsaWQgdmFsdWUgZm9yICR7a2V5fTogJHtKU09OLnN0cmluZ2lmeShwZXJzb25ba2V5XSwgbnVsbCwgMil9YCk7XG4gICAgICByZXQgPSBmYWxzZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJldDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVuc3VyZVBlcnNvbihvOiBQYXJ0aWFsPElQZXJzb24+IHwgSVBlcnNvbiB8IElQYXJ0aWFsUGVyc29uKTogSVBlcnNvbiB7XG4gIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKG8pKSB7XG4gICAgaWYgKCFpc1BlcnNvblByb3Aoa2V5KSkgeyBkZWxldGUgb1trZXkgYXMga2V5b2YgSVBlcnNvbl07IH1cbiAgfVxuICBmb3IgKGNvbnN0IGtleSBvZiBwZXJzb25Qcm9wcykge1xuICAgIGlmICghcGVyc29uVmFsaWRhdG9yW2tleV0/LihvW2tleV0pKSB7IChvW2tleV0gYXMgdW5rbm93bikgPSBkZWZhdWx0UGVyc29uW2tleV07IH1cbiAgfVxuICByZXR1cm4gUGVyc29uQVBJLmh5ZHJhdGUobyk7XG59XG5cbmV4cG9ydCB7IElQZXJzb24gfTtcbiJdfQ==