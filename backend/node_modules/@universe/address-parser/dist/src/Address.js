import { Country, FacilityType, getCountryDesc, isCountry, isDirectional, StreetType } from '@universe/models';
import { toDirectional } from './data/Directional.js';
import { isUrbanization } from './data/FacilityType.js';
import { isStreetPrefix, streetTypeString, toStreetType } from './data/StreetType.js';
import { parse } from './parser/index.js';
import { isNumberOrCode } from './parser/tokenizer.js';
import { isOrdinal } from './parser/utils.js';
function concat(...values) {
    return values.filter(Boolean).join(' ').toUpperCase().trim();
}
// USPS likes to force some streets to always be expanded...
const forceStreetExpansion = new Set([StreetType.PLZ]);
const singleStreetSuffix = new Set([
    StreetType.BLFS, StreetType.BRKS, StreetType.CIRS, StreetType.CLFS, StreetType.CMNS,
    StreetType.CORS, StreetType.CTS, StreetType.XING, StreetType.XRDS, StreetType.DRS,
    StreetType.ESTS, StreetType.EXTS, StreetType.FLS, StreetType.FLDS, StreetType.FLTS,
    StreetType.FRDS, StreetType.JCTS, StreetType.KYS, StreetType.KNLS, StreetType.MEWS,
    StreetType.MDWS, StreetType.RDGS, StreetType.RIV, StreetType.SHLS, StreetType.SHRS,
    StreetType.SPGS, StreetType.SQS, StreetType.ST, StreetType.STS, StreetType.TER,
    StreetType.VLY, StreetType.VLYS, StreetType.VLG, StreetType.VLGS, StreetType.VIS,
    StreetType.WALK, StreetType.WAY, StreetType.WLS,
]);
function streetName(name, type) {
    if (!type || isStreetPrefix(type)) {
        return [name];
    }
    let streetTypeOut = type;
    if (forceStreetExpansion.has(type)) {
        streetTypeOut = streetTypeString(type) || type;
    }
    if (!name) {
        return [streetTypeOut];
    }
    if (name.startsWith('of the') || (isNumberOrCode(name) && !isOrdinal(name) && !isDirectional(name) && !singleStreetSuffix.has(type))) {
        return [streetTypeString(toStreetType(type), true), name];
    }
    return [name, streetTypeOut];
}
export class Address {
    address;
    constructor(...lines) {
        if (typeof lines[0] === 'string') {
            this.address = parse(lines.join('\n'));
        }
        else {
            this.address = lines[0];
        }
    }
    static label(addr) {
        if (!addr) {
            return {
                care: null,
                urbanization: null,
                line1: null,
                line2: null,
                city: null,
                state: null,
                zip: null,
                zip4: null,
                country: null,
            };
        }
        // Simple bug catching.
        if (addr.unitNum === addr.zip) {
            addr.unitNum = null;
        }
        // This is how USPS wants UMRs presented.
        if (addr.facilityType === FacilityType.UMR) {
            addr.facilityType = 'UNIT';
        }
        addr.streetPreDir = addr.streetPreDir ? toDirectional(addr.streetPreDir) : null;
        addr.streetPostDir = addr.streetPostDir ? toDirectional(addr.streetPostDir) : null;
        // Ensure we have clean PO Boxes for USPS.
        if (addr.facilityType === FacilityType.PO) {
            addr.facility = null;
        }
        let streetSegment = concat(addr.facilityType && !isUrbanization(addr.facilityType) ? '' : addr.number, isStreetPrefix(addr.streetType) ? streetTypeString(addr.streetType) : '', addr.streetPreDir, ...streetName(addr.streetName, addr.streetType), addr.streetPostDir);
        let facility = concat(addr.facilityType, addr.facility, addr.facilityType ? addr.number : '');
        const PIN = concat(addr.pinType || (addr.pinNum && '#'), addr.pinNum);
        const unit = concat(addr.unitAbbr || (addr.unitNum && '#'), addr.unitNum);
        let urbanization = null;
        if (isUrbanization(addr.facilityType)) {
            urbanization = concat(addr.facilityType, addr.facility);
            facility = null;
        }
        if (addr.facilityType === FacilityType.PO) {
            streetSegment = null;
        }
        const line2 = null;
        if (unit || PIN) {
            if ((facility && streetSegment) || (addr.facilityType === FacilityType.PO)) {
                facility = concat(facility, unit);
                facility = concat(facility, PIN);
            }
            else if (streetSegment) {
                streetSegment = concat(streetSegment, unit);
                streetSegment = concat(streetSegment, PIN);
            }
            else {
                facility = concat(facility, unit);
                facility = concat(facility, PIN);
            }
        }
        // if (PIN) {
        //   if (!facility && streetSegment && !addr.pinType) {
        //   }
        // }
        return {
            care: addr.care ? addr.care.toUpperCase() : null,
            urbanization,
            line1: facility || streetSegment,
            line2: ((facility && streetSegment) ? streetSegment : line2) || null,
            city: addr.city ? addr.city.toUpperCase() : null,
            state: addr.state ? addr.state : null,
            zip: addr.zip || null,
            zip4: addr.zip4 || null,
            country: addr.country || null,
        };
    }
    static lines(addr) {
        if (!addr) {
            return [null, null, null, null];
        }
        const label = Address.label(addr);
        const out = [
            label.care,
            label.urbanization,
            [label.line1, label.line2].filter(Boolean).join(' ').trim(),
            [label.city, label.state, label.zip ? ` ${label.zip}` : null].filter(Boolean).join(' ').trim(),
        ].filter(Boolean);
        if (isCountry(label.country) && label.country !== Country.USA && label.country !== Country.FOREIGN) {
            const name = getCountryDesc(label.country)?.name;
            name && out.push(name.toUpperCase());
        }
        return [
            out[0] || null,
            out[1] || null,
            out[2] || null,
            out[3] || null,
        ];
    }
    static print(addr) {
        if (!addr) {
            return '';
        }
        return Address.lines(addr).filter(Boolean).join('\n');
    }
    label() { return Address.label(this.address); }
    lines() { return Address.lines(this.address); }
    print() { return Address.print(this.address); }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWRkcmVzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9BZGRyZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBQUMsYUFBYSxFQUFpQixVQUFVLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUU3SCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3hELE9BQU8sRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdEYsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFjOUMsU0FBUyxNQUFNLENBQUMsR0FBRyxNQUF5QjtJQUMxQyxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO0FBQy9ELENBQUM7QUFFRCw0REFBNEQ7QUFDNUQsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ3ZELE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxHQUFHLENBQUM7SUFDakMsVUFBVSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsSUFBSTtJQUNuRixVQUFVLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsVUFBVSxD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QyxFQUFFLElBQUksQ0FBQztZQUNqRCxJQUFJLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUN2QyxDQUFDO1FBQ0QsT0FBTztZQUNMLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJO1lBQ2QsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUk7WUFDZCxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSTtZQUNkLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJO1NBQ2YsQ0FBQztJQUNKLENBQUM7SUFFRCxNQUFNLENBQUMsS0FBSyxDQUFDLElBQW9CO1FBQy9CLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUFDLE9BQU8sRUFBRSxDQUFDO1FBQUMsQ0FBQztRQUN6QixPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRU0sS0FBSyxLQUFnQixPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMxRCxLQUFLLEtBQW1FLE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdHLEtBQUssS0FBYSxPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztDQUMvRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvdW50cnksIEZhY2lsaXR5VHlwZSwgZ2V0Q291bnRyeURlc2MsIGlzQ291bnRyeSxpc0RpcmVjdGlvbmFsLCBJU2l0dXMsIFN0YXRlLCBTdHJlZXRUeXBlIH0gZnJvbSAnQHVuaXZlcnNlL21vZGVscyc7XG5cbmltcG9ydCB7IHRvRGlyZWN0aW9uYWwgfSBmcm9tICcuL2RhdGEvRGlyZWN0aW9uYWwuanMnO1xuaW1wb3J0IHsgaXNVcmJhbml6YXRpb24gfSBmcm9tICcuL2RhdGEvRmFjaWxpdHlUeXBlLmpzJztcbmltcG9ydCB7IGlzU3RyZWV0UHJlZml4LCBzdHJlZXRUeXBlU3RyaW5nLCB0b1N0cmVldFR5cGUgfSBmcm9tICcuL2RhdGEvU3RyZWV0VHlwZS5qcyc7XG5pbXBvcnQgeyBwYXJzZSB9IGZyb20gJy4vcGFyc2VyL2luZGV4LmpzJztcbmltcG9ydCB7IGlzTnVtYmVyT3JDb2RlIH0gZnJvbSAnLi9wYXJzZXIvdG9rZW5pemVyLmpzJztcbmltcG9ydCB7IGlzT3JkaW5hbCB9IGZyb20gJy4vcGFyc2VyL3V0aWxzLmpzJztcblxuZXhwb3J0IGludGVyZmFjZSBVU1BTTGFiZWwge1xuICBjYXJlOiBzdHJpbmcgfCBudWxsO1xuICB1cmJhbml6YXRpb246IHN0cmluZyB8IG51bGw7XG4gIGxpbmUxOiBzdHJpbmcgfCBudWxsO1xuICBsaW5lMjogc3RyaW5nIHwgbnVsbDtcbiAgY2l0eTogc3RyaW5nIHwgbnVsbDtcbiAgc3RhdGU6IFN0YXRlIHwgbnVsbDtcbiAgemlwOiBzdHJpbmcgfCBudWxsO1xuICB6aXA0OiBzdHJpbmcgfCBudWxsO1xuICBjb3VudHJ5OiBzdHJpbmcgfCBudWxsO1xufVxuXG5mdW5jdGlvbiBjb25jYXQoLi4udmFsdWVzOiAoc3RyaW5nIHwgbnVsbClbXSk6IHN0cmluZyB7XG4gIHJldHVybiB2YWx1ZXMuZmlsdGVyKEJvb2xlYW4pLmpvaW4oJyAnKS50b1VwcGVyQ2FzZSgpLnRyaW0oKTtcbn1cblxuLy8gVVNQUyBsaWtlcyB0byBmb3JjZSBzb21lIHN0cmVldHMgdG8gYWx3YXlzIGJlIGV4cGFuZGVkLi4uXG5jb25zdCBmb3JjZVN0cmVldEV4cGFuc2lvbiA9IG5ldyBTZXQoW1N0cmVldFR5cGUuUExaXSk7XG5jb25zdCBzaW5nbGVTdHJlZXRTdWZmaXggPSBuZXcgU2V0KFtcbiAgU3RyZWV0VHlwZS5CTEZTLCBTdHJlZXRUeXBlLkJSS1MsIFN0cmVldFR5cGUuQ0lSUywgU3RyZWV0VHlwZS5DTEZTLCBTdHJlZXRUeXBlLkNNTlMsXG4gIFN0cmVldFR5cGUuQ09SUywgU3RyZWV0VHlwZS5DVFMsIFN0cmVldFR5cGUuWElORywgU3RyZWV0VHlwZS5YUkRTLCBTdHJlZXRUeXBlLkRSUyxcbiAgU3RyZWV0VHlwZS5FU1RTLCBTdHJlZXRUeXBlLkVYVFMsIFN0cmVldFR5cGUuRkxTLCBTdHJlZXRUeXBlLkZMRFMsIFN0cmVldFR5cGUuRkxUUyxcbiAgU3RyZWV0VHlwZS5GUkRTLCBTdHJlZXRUeXBlLkpDVFMsIFN0cmVldFR5cGUuS1lTLCBTdHJlZXRUeXBlLktOTFMsIFN0cmVldFR5cGUuTUVXUyxcbiAgU3RyZWV0VHlwZS5NRFdTLCBTdHJlZXRUeXBlLlJER1MsIFN0cmVldFR5cGUuUklWLCBTdHJlZXRUeXBlLlNITFMsIFN0cmVldFR5cGUuU0hSUyxcbiAgU3RyZWV0VHlwZS5TUEdTLCBTdHJlZXRUeXBlLlNRUywgU3RyZWV0VHlwZS5TVCwgU3RyZWV0VHlwZS5TVFMsIFN0cmVldFR5cGUuVEVSLFxuICBTdHJlZXRUeXBlLlZMWSwgU3RyZWV0VHlwZS5WTFlTLCBTdHJlZXRUeXBlLlZMRywgU3RyZWV0VHlwZS5WTEdTLCBTdHJlZXRUeXBlLlZJUyxcbiAgU3RyZWV0VHlwZS5XQUxLLCBTdHJlZXRUeXBlLldBWSwgU3RyZWV0VHlwZS5XTFMsXG5dKTtcbmZ1bmN0aW9uIHN0cmVldE5hbWUobmFtZTogc3RyaW5nIHwgbnVsbCwgdHlwZTogU3RyZWV0VHlwZSB8IG51bGwpOiAoc3RyaW5nIHwgbnVsbClbXSB7XG4gIGlmICghdHlwZSB8fCBpc1N0cmVldFByZWZpeCh0eXBlKSkgeyByZXR1cm4gW25hbWVdOyB9XG5cbiAgbGV0IHN0cmVldFR5cGVPdXQ6IHN0cmluZyA9IHR5cGU7XG4gIGlmIChmb3JjZVN0cmVldEV4cGFuc2lvbi5oYXModHlwZSkpIHsgc3RyZWV0VHlwZU91dCA9IHN0cmVldFR5cGVTdHJpbmcodHlwZSkgfHwgdHlwZTsgfVxuXG4gIGlmICghbmFtZSkgeyByZXR1cm4gW3N0cmVldFR5cGVPdXRdOyB9XG5cbiAgaWYgKG5hbWUuc3RhcnRzV2l0aCgnb2YgdGhlJykgfHwgKGlzTnVtYmVyT3JDb2RlKG5hbWUpICYmICFpc09yZGluYWwobmFtZSkgJiYgIWlzRGlyZWN0aW9uYWwobmFtZSkgJiYgIXNpbmdsZVN0cmVldFN1ZmZpeC5oYXModHlwZSkpKSB7XG4gICAgcmV0dXJuIFsgc3RyZWV0VHlwZVN0cmluZyh0b1N0cmVldFR5cGUodHlwZSksIHRydWUpLCBuYW1lIF07XG4gIH1cblxuICByZXR1cm4gWyBuYW1lLCBzdHJlZXRUeXBlT3V0IF07XG59XG5cbmV4cG9ydCBjbGFzcyBBZGRyZXNzIHtcbiAgYWRkcmVzczogSVNpdHVzO1xuXG4gIGNvbnN0cnVjdG9yKC4uLmxpbmVzOiBzdHJpbmdbXSB8IElTaXR1c1tdKSB7XG4gICAgaWYgKHR5cGVvZiBsaW5lc1swXSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHRoaXMuYWRkcmVzcyA9IHBhcnNlKGxpbmVzLmpvaW4oJ1xcbicpKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB0aGlzLmFkZHJlc3MgPSBsaW5lc1swXTtcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgbGFiZWwoYWRkcj86IElTaXR1cyB8IG51bGwpOiBVU1BTTGFiZWwge1xuICAgIGlmICghYWRkcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgY2FyZTogbnVsbCxcbiAgICAgICAgdXJiYW5pemF0aW9uOiBudWxsLFxuICAgICAgICBsaW5lMTogbnVsbCxcbiAgICAgICAgbGluZTI6IG51bGwsXG4gICAgICAgIGNpdHk6IG51bGwsXG4gICAgICAgIHN0YXRlOiBudWxsLFxuICAgICAgICB6aXA6IG51bGwsXG4gICAgICAgIHppcDQ6IG51bGwsXG4gICAgICAgIGNvdW50cnk6IG51bGwsXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIFNpbXBsZSBidWcgY2F0Y2hpbmcuXG4gICAgaWYgKGFkZHIudW5pdE51bSA9PT0gYWRkci56aXApIHsgYWRkci51bml0TnVtID0gbnVsbDsgfVxuXG4gICAgLy8gVGhpcyBpcyBob3cgVVNQUyB3YW50cyBVTVJzIHByZXNlbnRlZC5cbiAgICBpZiAoYWRkci5mYWNpbGl0eVR5cGUgPT09IEZhY2lsaXR5VHlwZS5VTVIpIHtcbiAgICAgIGFkZHIuZmFjaWxpdHlUeXBlID0gJ1VOSVQnIGFzIEZhY2lsaXR5VHlwZTtcbiAgICB9XG5cbiAgICBhZGRyLnN0cmVldFByZURpciA9IGFkZHIuc3RyZWV0UHJlRGlyID8gdG9EaXJlY3Rpb25hbChhZGRyLnN0cmVldFByZURpcikgOiBudWxsO1xuICAgIGFkZHIuc3RyZWV0UG9zdERpciA9IGFkZHIuc3RyZWV0UG9zdERpciA/IHRvRGlyZWN0aW9uYWwoYWRkci5zdHJlZXRQb3N0RGlyKSA6IG51bGw7XG5cbiAgICAvLyBFbnN1cmUgd2UgaGF2ZSBjbGVhbiBQTyBCb3hlcyBmb3IgVVNQUy5cbiAgICBpZiAoYWRkci5mYWNpbGl0eVR5cGUgPT09IEZhY2lsaXR5VHlwZS5QTykge1xuICAgICAgYWRkci5mYWNpbGl0eSA9IG51bGw7XG4gICAgfVxuXG4gICAgbGV0IHN0cmVldFNlZ21lbnQ6IHN0cmluZyB8IG51bGwgPSBjb25jYXQoXG4gICAgICBhZGRyLmZhY2lsaXR5VHlwZSAmJiAhaXNVcmJhbml6YXRpb24oYWRkci5mYWNpbGl0eVR5cGUpID8gJycgOiBhZGRyLm51bWJlcixcbiAgICAgIGlzU3RyZWV0UHJlZml4KGFkZHIuc3RyZWV0VHlwZSkgPyBzdHJlZXRUeXBlU3RyaW5nKGFkZHIuc3RyZWV0VHlwZSkgOiAnJyxcbiAgICAgIGFkZHIuc3RyZWV0UHJlRGlyLFxuICAgICAgLi4uc3RyZWV0TmFtZShhZGRyLnN0cmVldE5hbWUsIGFkZHIuc3RyZWV0VHlwZSksXG4gICAgICBhZGRyLnN0cmVldFBvc3REaXIsXG4gICAgKTtcbiAgICBsZXQgZmFjaWxpdHk6IHN0cmluZyB8IG51bGwgPSBjb25jYXQoYWRkci5mYWNpbGl0eVR5cGUsIGFkZHIuZmFjaWxpdHksIGFkZHIuZmFjaWxpdHlUeXBlID8gYWRkci5udW1iZXIgOiAnJyk7XG4gICAgY29uc3QgUElOID0gY29uY2F0KGFkZHIucGluVHlwZSB8fCAoYWRkci5waW5OdW0gJiYgJyMnKSwgYWRkci5waW5OdW0pO1xuICAgIGNvbnN0IHVuaXQgPSBjb25jYXQoYWRkci51bml0QWJiciB8fCAoYWRkci51bml0TnVtICYmICcjJyksIGFkZHIudW5pdE51bSk7XG5cbiAgICBsZXQgdXJiYW5pemF0aW9uID0gbnVsbDtcbiAgICBpZiAoaXNVcmJhbml6YXRpb24oYWRkci5mYWNpbGl0eVR5cGUpKSB7XG4gICAgICB1cmJhbml6YXRpb24gPSBjb25jYXQoYWRkci5mYWNpbGl0eVR5cGUsIGFkZHIuZmFjaWxpdHkpO1xuICAgICAgZmFjaWxpdHkgPSBudWxsO1xuICAgIH1cblxuICAgIGlmIChhZGRyLmZhY2lsaXR5VHlwZSA9PT0gRmFjaWxpdHlUeXBlLlBPKSB7XG4gICAgICBzdHJlZXRTZWdtZW50ID0gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBsaW5lMiA9IG51bGw7XG4gICAgaWYgKHVuaXQgfHwgUElOKSB7XG4gICAgICBpZiAoKGZhY2lsaXR5ICYmIHN0cmVldFNlZ21lbnQpIHx8IChhZGRyLmZhY2lsaXR5VHlwZSA9PT0gRmFjaWxpdHlUeXBlLlBPKSkge1xuICAgICAgICBmYWNpbGl0eSA9IGNvbmNhdChmYWNpbGl0eSwgdW5pdCk7XG4gICAgICAgIGZhY2lsaXR5ID0gY29uY2F0KGZhY2lsaXR5LCBQSU4pO1xuICAgICAgfVxuXG4gICAgICBlbHNlIGlmIChzdHJlZXRTZWdtZW50KSB7XG4gICAgICAgIHN0cmVldFNlZ21lbnQgPSBjb25jYXQoc3RyZWV0U2VnbWVudCwgdW5pdCk7XG4gICAgICAgIHN0cmVldFNlZ21lbnQgPSBjb25jYXQoc3RyZWV0U2VnbWVudCwgUElOKTtcbiAgICAgIH1cblxuICAgICAgZWxzZSB7XG4gICAgICAgIGZhY2lsaXR5ID0gY29uY2F0KGZhY2lsaXR5LCB1bml0KTtcbiAgICAgICAgZmFjaWxpdHkgPSBjb25jYXQoZmFjaWxpdHksIFBJTik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gaWYgKFBJTikge1xuICAgIC8vICAgaWYgKCFmYWNpbGl0eSAmJiBzdHJlZXRTZWdtZW50ICYmICFhZGRyLnBpblR5cGUpIHtcbiAgICAvLyAgIH1cbiAgICAvLyB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgY2FyZTogYWRkci5jYXJlID8gYWRkci5jYXJlLnRvVXBwZXJDYXNlKCkgOiBudWxsLFxuICAgICAgdXJiYW5pemF0aW9uLFxuICAgICAgbGluZTE6IGZhY2lsaXR5IHx8IHN0cmVldFNlZ21lbnQsXG4gICAgICBsaW5lMjogKChmYWNpbGl0eSAmJiBzdHJlZXRTZWdtZW50KSA/IHN0cmVldFNlZ21lbnQgOiBsaW5lMikgfHwgbnVsbCxcbiAgICAgIGNpdHk6IGFkZHIuY2l0eSA/IGFkZHIuY2l0eS50b1VwcGVyQ2FzZSgpIDogbnVsbCxcbiAgICAgIHN0YXRlOiBhZGRyLnN0YXRlID8gYWRkci5zdGF0ZSA6IG51bGwsXG4gICAgICB6aXA6IGFkZHIuemlwIHx8IG51bGwsXG4gICAgICB6aXA0OiBhZGRyLnppcDQgfHwgbnVsbCxcbiAgICAgIGNvdW50cnk6IGFkZHIuY291bnRyeSB8fCBudWxsLFxuICAgIH07XG4gIH1cblxuICBzdGF0aWMgbGluZXMoYWRkcj86IElTaXR1cyB8IG51bGwpOiBbc3RyaW5nIHwgbnVsbCwgc3RyaW5nIHwgbnVsbCwgc3RyaW5nIHwgbnVsbCwgc3RyaW5nIHwgbnVsbF0ge1xuICAgIGlmICghYWRkcikgeyByZXR1cm4gWyBudWxsLCBudWxsLCBudWxsLCBudWxsIF07IH1cbiAgICBjb25zdCBsYWJlbCA9IEFkZHJlc3MubGFiZWwoYWRkcik7XG4gICAgY29uc3Qgb3V0ID0gW1xuICAgICAgbGFiZWwuY2FyZSxcbiAgICAgIGxhYmVsLnVyYmFuaXphdGlvbixcbiAgICAgIFsgbGFiZWwubGluZTEsIGxhYmVsLmxpbmUyIF0uZmlsdGVyKEJvb2xlYW4pLmpvaW4oJyAnKS50cmltKCksXG4gICAgICBbIGxhYmVsLmNpdHksIGxhYmVsLnN0YXRlLCBsYWJlbC56aXAgPyBgICR7bGFiZWwuemlwfWAgOiBudWxsIF0uZmlsdGVyKEJvb2xlYW4pLmpvaW4oJyAnKS50cmltKCksXG4gICAgXS5maWx0ZXIoQm9vbGVhbik7XG4gICAgaWYgKGlzQ291bnRyeShsYWJlbC5jb3VudHJ5KSAmJiBsYWJlbC5jb3VudHJ5ICE9PSBDb3VudHJ5LlVTQSAmJiBsYWJlbC5jb3VudHJ5ICE9PSBDb3VudHJ5LkZPUkVJR04pIHtcbiAgICAgIGNvbnN0IG5hbWUgPSBnZXRDb3VudHJ5RGVzYyhsYWJlbC5jb3VudHJ5KT8ubmFtZTtcbiAgICAgIG5hbWUgJiYgb3V0LnB1c2gobmFtZS50b1VwcGVyQ2FzZSgpKTtcbiAgICB9XG4gICAgcmV0dXJuIFtcbiAgICAgIG91dFswXSB8fCBudWxsLFxuICAgICAgb3V0WzFdIHx8IG51bGwsXG4gICAgICBvdXRbMl0gfHwgbnVsbCxcbiAgICAgIG91dFszXSB8fCBudWxsLFxuICAgIF07XG4gIH1cblxuICBzdGF0aWMgcHJpbnQoYWRkcj86IElTaXR1cyB8IG51bGwpOiBzdHJpbmcge1xuICAgIGlmICghYWRkcikgeyByZXR1cm4gJyc7IH1cbiAgICByZXR1cm4gQWRkcmVzcy5saW5lcyhhZGRyKS5maWx0ZXIoQm9vbGVhbikuam9pbignXFxuJyk7XG4gIH1cblxuICBwdWJsaWMgbGFiZWwoKTogVVNQU0xhYmVsIHsgcmV0dXJuIEFkZHJlc3MubGFiZWwodGhpcy5hZGRyZXNzKTsgfVxuICBwdWJsaWMgbGluZXMoKTogW3N0cmluZyB8IG51bGwsIHN0cmluZyB8IG51bGwsIHN0cmluZyB8IG51bGwsIHN0cmluZyB8IG51bGxdIHsgcmV0dXJuIEFkZHJlc3MubGluZXModGhpcy5hZGRyZXNzKTsgfVxuICBwdWJsaWMgcHJpbnQoKTogc3RyaW5nIHsgcmV0dXJuIEFkZHJlc3MucHJpbnQodGhpcy5hZGRyZXNzKTsgfVxufVxuIl19